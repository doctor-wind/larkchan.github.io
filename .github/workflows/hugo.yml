name: Deploy Hugo site to Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.126.0"
          extended: true

      - name: Show Hugo env
        run: |
          hugo version
          hugo env

      - name: Fetch PaperMod theme
        run: |
          rm -rf themes/PaperMod
          mkdir -p themes
          git clone --depth=1 https://github.com/adityatelange/hugo-PaperMod themes/PaperMod

      - name: Ensure minimal config & content
        run: |
          echo "ðŸ‘‰ Repo owner: ${{ github.repository_owner }}"
          # 1) configï¼ˆè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºæœ€å°å¯ç”¨é…ç½®ï¼‰
          if [ ! -f "config.toml" ] && [ ! -f "config.yaml" ] && [ ! -f "config.yml" ]; then
            cat > config.toml <<EOF
baseURL = "https://${{ github.repository_owner }}.github.io/"
languageCode = "zh-cn"
title = "æˆ‘çš„åšå®¢"
theme = "PaperMod"
paginate = 10
[params]
  defaultTheme = "light"
  disableThemeToggle = true
  DateFormat = "2006-01-02"
  ShowReadingTime = false
  ShowShareButtons = false
  ShowCodeCopyButtons = true
  mainSections = ["daily","posts"]
[menu]
  [[menu.main]]
    name = "å½’æ¡£"
    url = "/archives/"
    weight = 10
[outputs]
  home = ["HTML","RSS","JSON"]
[permalinks]
  posts = "/:year/:month/:day/:slug/"
  daily = "/:year/:month/:day/:slug/"
EOF
          fi

          # 2) å½’æ¡£é¡µ
          mkdir -p content/archives
          if [ ! -f "content/archives/_index.md" ]; then
            cat > content/archives/_index.md <<'EOF'
---
title: "Archives"
layout: "archives"
---
EOF
          fi

          # 3) è‹¥æ²¡æœ‰ä»»ä½•æ–‡ç« ï¼Œåˆ›å»ºä¸€ç¯‡å ä½æ–‡ç« ï¼ˆå‘å¸ƒæ€ï¼‰
          COUNT=$(find content -type f -name '*.md' | wc -l || true)
          if [ "$COUNT" -eq 0 ]; then
            mkdir -p content/posts
            cat > content/posts/hello.md <<'EOF'
---
title: "Hello PaperMod"
date: 2025-08-28T09:00:00+08:00
draft: false
tags: ["note"]
cover:
  hidden: true
---
è¿™æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„å ä½æ–‡ç« ï¼Œç”¨äºŽéªŒè¯éƒ¨ç½²æ˜¯å¦æˆåŠŸã€‚çœ‹åˆ°å®ƒè¯´æ˜Žä¸»é¢˜å’Œæž„å»ºéƒ½æ­£å¸¸ã€‚
EOF
          fi

          echo "--------- repo tree ---------"
          ls -la
          echo "--------- content tree ------"
          (ls -R content || true)

      - name: Build
        run: hugo --minify --gc

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
